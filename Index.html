<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>顾客积分排行榜</title>
    <link rel="stylesheet" href="Style.css">
</head>
<body>

    <h1>顾客积分排行榜</h1>

    <div class="leaderboard-container">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="按姓名或电话号码搜索顾客...">
        </div>
        <table>
            <thead>
                <tr>
                    <th>排名</th>
                    <th data-sort-key="name">姓名</th>
                    <th data-sort-key="score">积分</th>
                    <th>电话号码</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        
        <div class="pagination">
            <button id="prevBtn">上一页</button>
            <span id="pageInfo"></span>
            <button id="nextBtn">下一页</button>
        </div>
    </div>
    
    <a href="rules.html" class="back-button">查看积分规则</a>

    <div id="notification-container"></div>

    <audio id="background-music" loop>
        <source src="bgm.mp3" type="audio/mpeg">
        您的浏览器不支持音频播放。
    </audio>
    <button id="music-button">🎵</button>

    <script>

// 每 10 秒刷新排行榜
setInterval(async () => {
    await fetchCustomers();
    updateLeaderboard();  // ✅ 会带着你输入的关键词过滤
}, 10000);

        //const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxbL473AQ6RKNjB5s8Hk_5BSwuKUTSyKjYwIihR-cJhAT7WrS6fOEH8t5jLocV1iOWZ9Q/exec';
	const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwQ8EFB0y3uGXu_CHtwM2YEUK-HQaW0xjhvryInLM-DPk_gsB1850ojN5Mhwuz7uJK00w/exec';        


        let customers = [];
        let lastRankedData = [];
        let sortDirection = 'desc';
        let sortBy = 'score';
        let currentPage = 1;
        const itemsPerPage = 10;
        const tableBody = document.querySelector(".leaderboard-container tbody");
        const searchInput = document.getElementById("searchInput");
        const tableHeaders = document.querySelectorAll("thead th[data-sort-key]");
        const notificationContainer = document.getElementById("notification-container");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const pageInfo = document.getElementById("pageInfo");
        const backgroundMusic = document.getElementById("background-music");
        const musicButton = document.getElementById("music-button");
        
        backgroundMusic.volume = 0.5;
        backgroundMusic.onerror = function() {
            showNotification('音乐加载失败，请检查 bgm.mp3 文件是否存在。');
        };

        async function fetchCustomers() {
            try {
                const response = await fetch(WEB_APP_URL);
                customers = await response.json();
            } catch (error) {
                console.error('获取顾客数据失败:', error);
                showNotification('无法连接到服务器，请检查网络或配置。');
            }
        }

        async function initialize() {
            await fetchCustomers();
            if (customers.length === 0) {
                console.log('Google Sheets 中没有顾客数据。');
            }
            updateLeaderboard();
        }
        
       function getRankedData() {
    const searchTerm = searchInput.value.toLowerCase();

    // 1. 排序所有顾客（按积分从高到低）
    const allRankedCustomers = [...customers].sort((a, b) => {
        const aScore = Number(a.score) || 0;
        const bScore = Number(b.score) || 0;

        if (sortBy === 'score') {
            return sortDirection === 'desc' ? bScore - aScore : aScore - bScore;
        } else {
            // fallback for name 排序
            return sortDirection === 'desc'
                ? b[sortBy].localeCompare(a[sortBy])
                : a[sortBy].localeCompare(b[sortBy]);
        }
    });

    // 2. 赋予排名
    const rankedData = allRankedCustomers.map((customer, index) => {
        customer.previousRank = customer.currentRank || (index + 1);
        customer.currentRank = index + 1;
        return {
            rank: index + 1,
            name: customer.name,
            score: Number(customer.score) || 0, // 确保是数字
            phone: customer.phone,
            previousRank: customer.previousRank
        };
    });

    // 3. 搜索过滤（按姓名或电话）
    return rankedData.filter(customer =>
        customer.name.toLowerCase().includes(searchTerm) ||
        customer.phone.includes(searchTerm)
    );
}


        function formatPhoneNumber(fullPhoneNumber) {
            if (fullPhoneNumber && fullPhoneNumber.length >= 4) {
                const lastFourDigits = fullPhoneNumber.slice(-4);
                return `*****${lastFourDigits}`;
            }
            return fullPhoneNumber;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.classList.add('notification');
            notification.textContent = message;
            notificationContainer.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slide-out 0.5s forwards';
                setTimeout(() => {
                    notificationContainer.removeChild(notification);
                }, 500);
            }, 3000);
        }

        function updateLeaderboard() {
            const rankedData = getRankedData();
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = rankedData.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">没有找到匹配的顾客。</td></tr>';
                document.querySelector('.pagination').style.display = 'none';
                return;
            } else {
                document.querySelector('.pagination').style.display = 'flex';
            }
            
            tableBody.innerHTML = '';
            pageData.forEach((customer, index) => {
                const row = document.createElement("tr");
                if (customer.previousRank - customer.rank >= 3) {
                    row.classList.add('rank-up-effect');
                }
                if (customer.rank === 1) {
                    row.classList.add('first-place');
                } else if (customer.rank === 2) {
                    row.classList.add('second-place');
                } else if (customer.rank === 3) {
                    row.classList.add('third-place');
                }
                const rankCell = document.createElement("td");
                const nameCell = document.createElement("td");
                const scoreCell = document.createElement("td");
                const phoneCell = document.createElement("td");
                const rankNumberSpan = document.createElement('span');
                rankNumberSpan.textContent = customer.rank;
                rankCell.appendChild(rankNumberSpan);
                const rankChangeSpan = document.createElement('span');
                rankChangeSpan.classList.add('rank-change');
                if (customer.previousRank > customer.rank && customer.previousRank !== 0) {
                    rankChangeSpan.innerHTML = '&#9650;';
                    rankChangeSpan.classList.add('rank-up');
                    rankCell.appendChild(rankChangeSpan);
                } else if (customer.previousRank < customer.rank && customer.previousRank !== 0) {
                    rankChangeSpan.innerHTML = '&#9660;';
                    rankChangeSpan.classList.add('rank-down');
                    rankCell.appendChild(rankChangeSpan);
                }
                nameCell.textContent = customer.name;
                scoreCell.textContent = customer.score;
                phoneCell.textContent = formatPhoneNumber(customer.phone);
                const oldCustomer = lastRankedData.find(c => c.name === customer.name);
                if (oldCustomer && (oldCustomer.score !== customer.score || oldCustomer.rank !== customer.rank)) {
                    row.classList.add('highlight');
                    setTimeout(() => {
                        row.classList.remove('highlight');
                    }, 2000);
                }
                row.appendChild(rankCell);
                row.appendChild(nameCell);
                row.appendChild(scoreCell);
                row.appendChild(phoneCell);
                tableBody.appendChild(row);
            });
            lastRankedData = rankedData;  // instead of pageData
            const totalPages = Math.ceil(rankedData.length / itemsPerPage);
            pageInfo.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }
        
// 触发搜索: 输入、键盘放开、失焦
searchInput.addEventListener('input', () => {
    currentPage = 1;
    updateLeaderboard();
});

searchInput.addEventListener('keyup', () => {
    currentPage = 1;
    updateLeaderboard();
});

searchInput.addEventListener('change', () => {
    currentPage = 1;
    updateLeaderboard();
});
        
        tableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const key = header.getAttribute('data-sort-key');
                if (sortBy === key) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortBy = key;
                    sortDirection = 'desc';
                }
                currentPage = 1;
                updateLeaderboard();
            });
        });
        
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updateLeaderboard();
            }
        });
        
        nextBtn.addEventListener('click', () => {
            const rankedData = getRankedData();
            const totalPages = Math.ceil(rankedData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateLeaderboard();
            }
        });
        
        let isPlaying = false;
        musicButton.addEventListener('click', () => {
            if (isPlaying) {
                backgroundMusic.pause();
                musicButton.textContent = '🎵';
            } else {
                backgroundMusic.play().then(() => {
                    musicButton.textContent = '⏸️';
                }).catch(error => {
                    showNotification('自动播放受限，请在浏览器设置中启用自动播放。');
                    console.error('Playback failed:', error);
                });
            }
            isPlaying = !isPlaying;
        });

        initialize();
    </script>
</body>

</html>
