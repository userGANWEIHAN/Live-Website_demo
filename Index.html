<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¾å®¢ç§¯åˆ†æ’è¡Œæ¦œ</title>
    <link rel="stylesheet" href="Style.css">
</head>
<body>

    <h1>é¡¾å®¢ç§¯åˆ†æ’è¡Œæ¦œ</h1>

    <div class="leaderboard-container">
        <div class="search-container">
            <input type="text" id="searchInput" placeholder="æŒ‰å§“åæˆ–ç”µè¯å·ç æœç´¢é¡¾å®¢...">
        </div>
        <table>
            <thead>
                <tr>
                    <th>æ’å</th>
                    <th data-sort-key="name">å§“å</th>
                    <th data-sort-key="score">ç§¯åˆ†</th>
                    <th>ç”µè¯å·ç </th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
        
        <div class="pagination">
            <button id="prevBtn">ä¸Šä¸€é¡µ</button>
            <span id="pageInfo"></span>
            <button id="nextBtn">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>
    
    <a href="rules.html" class="back-button">æŸ¥çœ‹ç§¯åˆ†è§„åˆ™</a>

    <div id="notification-container"></div>

    <audio id="background-music" loop>
        <source src="bgm.mp3" type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾ã€‚
    </audio>
    <button id="music-button">ğŸµ</button>

    <script>

// æ¯ 10 ç§’åˆ·æ–°æ’è¡Œæ¦œ
setInterval(async () => {
    await fetchCustomers();
    updateLeaderboard();  // âœ… ä¼šå¸¦ç€ä½ è¾“å…¥çš„å…³é”®è¯è¿‡æ»¤
}, 10000);

        //const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxbL473AQ6RKNjB5s8Hk_5BSwuKUTSyKjYwIihR-cJhAT7WrS6fOEH8t5jLocV1iOWZ9Q/exec';
	const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwQ8EFB0y3uGXu_CHtwM2YEUK-HQaW0xjhvryInLM-DPk_gsB1850ojN5Mhwuz7uJK00w/exec';        


        let customers = [];
        let lastRankedData = [];
        let sortDirection = 'desc';
        let sortBy = 'score';
        let currentPage = 1;
        const itemsPerPage = 10;
        const tableBody = document.querySelector(".leaderboard-container tbody");
        const searchInput = document.getElementById("searchInput");
        const tableHeaders = document.querySelectorAll("thead th[data-sort-key]");
        const notificationContainer = document.getElementById("notification-container");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const pageInfo = document.getElementById("pageInfo");
        const backgroundMusic = document.getElementById("background-music");
        const musicButton = document.getElementById("music-button");
        
        backgroundMusic.volume = 0.5;
        backgroundMusic.onerror = function() {
            showNotification('éŸ³ä¹åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ bgm.mp3 æ–‡ä»¶æ˜¯å¦å­˜åœ¨ã€‚');
        };

        async function fetchCustomers() {
            try {
                const response = await fetch(WEB_APP_URL);
                customers = await response.json();
            } catch (error) {
                console.error('è·å–é¡¾å®¢æ•°æ®å¤±è´¥:', error);
                showNotification('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–é…ç½®ã€‚');
            }
        }

        async function initialize() {
            await fetchCustomers();
            if (customers.length === 0) {
                console.log('Google Sheets ä¸­æ²¡æœ‰é¡¾å®¢æ•°æ®ã€‚');
            }
            updateLeaderboard();
        }
        
       function getRankedData() {
    const searchTerm = searchInput.value.toLowerCase();

    // 1. æ’åºæ‰€æœ‰é¡¾å®¢ï¼ˆæŒ‰ç§¯åˆ†ä»é«˜åˆ°ä½ï¼‰
    const allRankedCustomers = [...customers].sort((a, b) => {
        const aScore = Number(a.score) || 0;
        const bScore = Number(b.score) || 0;

        if (sortBy === 'score') {
            return sortDirection === 'desc' ? bScore - aScore : aScore - bScore;
        } else {
            // fallback for name æ’åº
            return sortDirection === 'desc'
                ? b[sortBy].localeCompare(a[sortBy])
                : a[sortBy].localeCompare(b[sortBy]);
        }
    });

    // 2. èµ‹äºˆæ’å
    const rankedData = allRankedCustomers.map((customer, index) => {
        customer.previousRank = customer.currentRank || (index + 1);
        customer.currentRank = index + 1;
        return {
            rank: index + 1,
            name: customer.name,
            score: Number(customer.score) || 0, // ç¡®ä¿æ˜¯æ•°å­—
            phone: customer.phone,
            previousRank: customer.previousRank
        };
    });

    // 3. æœç´¢è¿‡æ»¤ï¼ˆæŒ‰å§“åæˆ–ç”µè¯ï¼‰
    return rankedData.filter(customer =>
        customer.name.toLowerCase().includes(searchTerm) ||
        customer.phone.includes(searchTerm)
    );
}


        function formatPhoneNumber(fullPhoneNumber) {
            if (fullPhoneNumber && fullPhoneNumber.length >= 4) {
                const lastFourDigits = fullPhoneNumber.slice(-4);
                return `*****${lastFourDigits}`;
            }
            return fullPhoneNumber;
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.classList.add('notification');
            notification.textContent = message;
            notificationContainer.appendChild(notification);
            setTimeout(() => {
                notification.style.animation = 'slide-out 0.5s forwards';
                setTimeout(() => {
                    notificationContainer.removeChild(notification);
                }, 500);
            }, 3000);
        }

        function updateLeaderboard() {
            const rankedData = getRankedData();
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = rankedData.slice(startIndex, endIndex);
            
            if (pageData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é¡¾å®¢ã€‚</td></tr>';
                document.querySelector('.pagination').style.display = 'none';
                return;
            } else {
                document.querySelector('.pagination').style.display = 'flex';
            }
            
            tableBody.innerHTML = '';
            pageData.forEach((customer, index) => {
                const row = document.createElement("tr");
                if (customer.previousRank - customer.rank >= 3) {
                    row.classList.add('rank-up-effect');
                }
                if (customer.rank === 1) {
                    row.classList.add('first-place');
                } else if (customer.rank === 2) {
                    row.classList.add('second-place');
                } else if (customer.rank === 3) {
                    row.classList.add('third-place');
                }
                const rankCell = document.createElement("td");
                const nameCell = document.createElement("td");
                const scoreCell = document.createElement("td");
                const phoneCell = document.createElement("td");
                const rankNumberSpan = document.createElement('span');
                rankNumberSpan.textContent = customer.rank;
                rankCell.appendChild(rankNumberSpan);
                const rankChangeSpan = document.createElement('span');
                rankChangeSpan.classList.add('rank-change');
                if (customer.previousRank > customer.rank && customer.previousRank !== 0) {
                    rankChangeSpan.innerHTML = '&#9650;';
                    rankChangeSpan.classList.add('rank-up');
                    rankCell.appendChild(rankChangeSpan);
                } else if (customer.previousRank < customer.rank && customer.previousRank !== 0) {
                    rankChangeSpan.innerHTML = '&#9660;';
                    rankChangeSpan.classList.add('rank-down');
                    rankCell.appendChild(rankChangeSpan);
                }
                nameCell.textContent = customer.name;
                scoreCell.textContent = customer.score;
                phoneCell.textContent = formatPhoneNumber(customer.phone);
                const oldCustomer = lastRankedData.find(c => c.name === customer.name);
                if (oldCustomer && (oldCustomer.score !== customer.score || oldCustomer.rank !== customer.rank)) {
                    row.classList.add('highlight');
                    setTimeout(() => {
                        row.classList.remove('highlight');
                    }, 2000);
                }
                row.appendChild(rankCell);
                row.appendChild(nameCell);
                row.appendChild(scoreCell);
                row.appendChild(phoneCell);
                tableBody.appendChild(row);
            });
            lastRankedData = rankedData;  // instead of pageData
            const totalPages = Math.ceil(rankedData.length / itemsPerPage);
            pageInfo.textContent = `ç¬¬ ${currentPage} é¡µ / å…± ${totalPages} é¡µ`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }
        
// è§¦å‘æœç´¢: è¾“å…¥ã€é”®ç›˜æ”¾å¼€ã€å¤±ç„¦
searchInput.addEventListener('input', () => {
    currentPage = 1;
    updateLeaderboard();
});

searchInput.addEventListener('keyup', () => {
    currentPage = 1;
    updateLeaderboard();
});

searchInput.addEventListener('change', () => {
    currentPage = 1;
    updateLeaderboard();
});
        
        tableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const key = header.getAttribute('data-sort-key');
                if (sortBy === key) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortBy = key;
                    sortDirection = 'desc';
                }
                currentPage = 1;
                updateLeaderboard();
            });
        });
        
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                updateLeaderboard();
            }
        });
        
        nextBtn.addEventListener('click', () => {
            const rankedData = getRankedData();
            const totalPages = Math.ceil(rankedData.length / itemsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateLeaderboard();
            }
        });
        
        let isPlaying = false;
        musicButton.addEventListener('click', () => {
            if (isPlaying) {
                backgroundMusic.pause();
                musicButton.textContent = 'ğŸµ';
            } else {
                backgroundMusic.play().then(() => {
                    musicButton.textContent = 'â¸ï¸';
                }).catch(error => {
                    showNotification('è‡ªåŠ¨æ’­æ”¾å—é™ï¼Œè¯·åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å¯ç”¨è‡ªåŠ¨æ’­æ”¾ã€‚');
                    console.error('Playback failed:', error);
                });
            }
            isPlaying = !isPlaying;
        });

        initialize();
    </script>
</body>

</html>
